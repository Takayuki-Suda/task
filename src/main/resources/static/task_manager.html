<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>タスク管理アプリ</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f8f9fa;
        transition: background-color 0.3s, color 0.3s;
      }
      body.dark-mode {
        background-color: #343a40;
        color: #f8f9fa;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
      }
      .task {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 5px 0;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        background-color: #ffffff;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .task.dark-mode {
        background-color: #495057;
        border-color: #ced4da;
      }
      .task button {
        margin-left: 10px;
      }
      .input-group-append {
        flex-grow: 1;
      }

      .btn-sm {
        font-size: 0.9rem;
      }
      #addButton,
      #search {
        min-width: 120px;
      }

      input.form-control {
        transition: background-color 0.3s, color 0.3s;
      }
      input.form-control.dark-mode {
        background-color: #495057;
        color: #f8f9fa;
      }
      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      .pagination button {
        margin: 0 5px;
      }
      .current-page {
        text-align: center;
        margin-top: 10px;
      }
      .task-count {
        text-align: center;
        margin-top: 10px;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>タスク管理アプリ</h1>

      <!-- 新規作成ボタン -->
      <button
        class="btn btn-primary mb-3"
        id="newTaskButton"
        data-toggle="modal"
        data-target="#taskModal"
      >
        新規作成
      </button>

      <!-- モーダル -->
      <div
        class="modal fade"
        id="taskModal"
        tabindex="-1"
        aria-labelledby="taskModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="taskModalLabel">
                新しいタスクを追加
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="taskInputModal">タスク名</label>
                <input
                  type="text"
                  class="form-control"
                  id="taskInputModal"
                  placeholder="タスク名を入力"
                />
              </div>
              <div class="form-group">
                <label for="dateInputModal">日付</label>
                <input type="date" class="form-control" id="dateInputModal" />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                閉じる
              </button>
              <button
                type="button"
                class="btn btn-primary"
                id="addTaskButton"
                onclick="addTaskFromModal()"
              >
                タスクを追加
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ダークモード切替ボタン -->
      <button
        class="btn btn-secondary mb-3"
        id="toggleButton"
        onclick="toggleDarkMode()"
      >
        ダークモード
      </button>

      <!-- 検索ボックス -->
      <div class="input-group mb-3">
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="タスクを検索"
          style="width: 34%"
        />
        <div class="input-group-append">
          <button
            class="btn btn-primary mx-2"
            id="search"
            onclick="searchTasks()"
          >
            検索する
          </button>
          <!-- リセットボタンを追加 -->
          <button class="btn btn-secondary" id="reset" onclick="resetSearch()">
            リセット
          </button>
        </div>
      </div>

      <h2>タスク一覧</h2>
      <div id="taskList" class="list-group"></div>

      <!-- ページ番号表示 -->
      <div class="pagination" id="pagination"></div>
      <div class="current-page" id="currentPageIndicator"></div>
      <!-- タスクの総数を表示する要素 -->
      <div class="task-count" id="taskCount"></div>
    </div>

    <script>
      const taskList = document.getElementById("taskList");
      const pagination = document.getElementById("pagination");
      const currentPageIndicator = document.getElementById(
        "currentPageIndicator"
      );
      const taskCount = document.getElementById("taskCount");
      let tasks = [];
      let currentPage = 1;
      const tasksPerPage = 4;
      let editingTaskId = null;

      function renderPagination(totalPages) {
        pagination.innerHTML = "";
        const maxVisiblePages = 5;

        const firstButton = document.createElement("button");
        firstButton.innerText = "«";
        firstButton.classList.add("btn", "btn-outline-primary");
        firstButton.onclick = () => changePage(1);
        pagination.appendChild(firstButton);

        const startPage = Math.max(
          1,
          currentPage - Math.floor(maxVisiblePages / 2)
        );
        const endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        for (let i = startPage; i <= endPage; i++) {
          const button = document.createElement("button");
          button.innerText = i;
          button.classList.add("btn", "btn-outline-primary");
          button.onclick = () => changePage(i);
          if (i === currentPage) {
            button.classList.add("active");
          }
          pagination.appendChild(button);
        }

        const lastButton = document.createElement("button");
        lastButton.innerText = "»";
        lastButton.classList.add("btn", "btn-outline-primary");
        lastButton.onclick = () => changePage(totalPages);
        pagination.appendChild(lastButton);
      }

      function updateCurrentPageIndicator() {
        currentPageIndicator.innerText = `現在のページ：${currentPage}`;
      }

      function updateTaskCount() {
        taskCount.innerText = `タスクの総数：${tasks.length}件`;
      }

      function changePage(page) {
        currentPage = page;
        loadTasks();
      }

      function addTaskFromModal() {
        const taskDescription = document
          .getElementById("taskInputModal")
          .value.trim();
        const taskDate = document.getElementById("dateInputModal").value;

        if (taskDescription) {
          fetch("/tasks", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              description: taskDescription,
              dueDate: taskDate,
              completed: false,
            }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("タスクの追加に失敗しました");
              }
              return response.json();
            })
            .then((task) => {
              tasks.push(task);
              loadTasks();
              document.getElementById("taskInputModal").value = "";
              document.getElementById("dateInputModal").value = "";
              $("#taskModal").modal("hide"); // モーダルを閉じる
            })
            .catch((error) => {
              console.error("Error:", error);
              alert(error.message);
            });
        }
      }

      function displayTask(task) {
        const taskItem = document.createElement("div");
        taskItem.className = "task";
        taskItem.innerHTML = `
        <div>
            <strong>${task.id}: ${task.description}</strong> - ${
          task.dueDate ? new Date(task.dueDate).toLocaleDateString() : "未設定"
        }
        </div>
        <div>
            <button class="btn btn-success btn-sm" onclick="editTask(${
              task.id
            })">編集</button>
            <button class="btn btn-danger btn-sm" onclick="deleteTask(${
              task.id
            })">削除</button>
        </div>
    `;
        taskList.appendChild(taskItem);
      }

      function loadTasks() {
        taskList.innerHTML = "";
        const startIndex = (currentPage - 1) * tasksPerPage;
        const endIndex = startIndex + tasksPerPage;

        // タスクを逆順に取得し、ページング
        const paginatedTasks = tasks
          .slice()
          .reverse()
          .slice(startIndex, endIndex);

        paginatedTasks.forEach(displayTask);

        const totalPages = Math.ceil(tasks.length / tasksPerPage);
        renderPagination(totalPages);
        updateCurrentPageIndicator();
        updateTaskCount();
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        document.querySelectorAll(".task").forEach((task) => {
          task.classList.toggle("dark-mode");
        });
        document.querySelectorAll("input.form-control").forEach((input) => {
          input.classList.toggle("dark-mode");
        });
      }

      let allTasks = []; // すべてのタスクを保持する配列

      // 初回ロード時にタスクを取得
      fetch("/tasks")
        .then((response) => response.json())
        .then((data) => {
          tasks = data;
          allTasks = [...data]; // すべてのタスクを保持
          loadTasks();
        })
        .catch((error) => console.error("Error:", error));

      function searchTasks() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();

        // 検索ボックスが空の場合は元のタスクリストを使用
        tasks = searchTerm
          ? allTasks.filter((task) =>
              task.description.toLowerCase().includes(searchTerm)
            )
          : [...allTasks];

        currentPage = 1; // Reset to the first page
        loadTasks();
      }

      function editTask(taskId) {
        editingTaskId = taskId;
        const taskToEdit = tasks.find((task) => task.id === taskId);
        document.getElementById("taskInputModal").value =
          taskToEdit.description;
        document.getElementById("dateInputModal").value = taskToEdit.dueDate
          ? new Date(taskToEdit.dueDate).toISOString().split("T")[0]
          : "";
        $("#taskModal").modal("show"); // モーダルを再表示
      }

      function deleteTask(taskId) {
        fetch(`/tasks/${taskId}`, {
          method: "DELETE",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("タスクの削除に失敗しました");
            }
            tasks = tasks.filter((task) => task.id !== taskId);
            loadTasks();
          })
          .catch((error) => {
            console.error("Error:", error);
            alert(error.message);
          });
      }

      function resetSearch() {
        document.getElementById("searchInput").value = ""; // 検索ボックスを空にする
        tasks = [...allTasks]; // 全タスクを表示
        currentPage = 1; // ページをリセット
        loadTasks(); // タスクを再読み込み
      }

      // 初回ロード時にタスクを取得
      fetch("/tasks")
        .then((response) => response.json())
        .then((data) => {
          tasks = data;
          loadTasks();
        })
        .catch((error) => console.error("Error:", error));
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
